<!DOCTYPE HTML>
<html>
<head>
<title>KUOM Radio K</title>
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="phonegap.js"></script>
<script src="jquerymin.js"></script>
<script src="scrollfix.js"></script>
<link rel="stylesheet" type="text/css" href="reset-min.css?1">
<link rel="stylesheet" type="text/css" href="radiokapp.css">

<script type="text/javascript">



var debugging=false;

var retryInterval;
var retryAttempts=0;
var retrying=false;

var uiPlaying=false;

var singMedia;
var singing=false;
var singStatusNum=0;

var myStreamUrl="";
var streamPlaying=false;
var streamCreated=false;

var ios=false;
var iosStreamPlaying=false;
var iosStreamStatus=-1;
var iosStreamAudio={};
iosStreamAudio.readyState=-1;
var android=false;
var androidStreamPlaying=false;
var androidStreamStatus=-1;
var androidStreamMedia={};
// add functions in case object is referenced before created
androidStreamMedia.stop=new Function("{dbuga('stop() nothing android');}");
androidStreamMedia.release=new Function("{dbuga('release() nothing android');}");

var connection=true;
var connectionMessage="";
var stateMessage="";
var alarming=false;
var bufferTimeout;
function stopStream(){
  dbuga('stopStream()');
  if(android){
    androidStreamMedia.stop();
    }

  if(ios){ 
    iosStreamAudio.pause();
    iosStreamPlaying=false;
    streamPlaying=false;
    }
  }
var waitEvents=0;
function createStream(){
  myStreamUrl=urlByQuality[genericGet("quality")]+"";
  waitEvents=0;
  if(android){
    androidStreamMedia.stop();
    androidStreamMedia.release();
    //dbuga("createStream() android "+myStreamUrl);
    androidStreamMedia = new Media(myStreamUrl, androidSuccess, androidError, androidStatusCallback);
    }
  if(ios){
    //////if(streamCreated){iosStreamAudio.pause();}
    dbuga("createStream() ios "+myStreamUrl);
    iosStreamAudio.onabort = null;
    iosStreamAudio.onemptied = null;
    iosStreamAudio.onerror = null;
    iosStreamAudio.onpause = null;
    iosStreamAudio.onseking = null;
    iosStreamAudio.onended = null;
    iosStreamAudio.onstalled = null;
    iosStreamAudio.onwaiting = null;
    iosStreamAudio.onplay = null;
    iosStreamAudio.onplaying = null;

    iosStreamAudio = null;
    iosStreamAudio = new Audio(myStreamUrl);

    iosStreamAudio.addEventListener("abort", function() {
       dbuga('iosStreamAudio abort');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("emptied", function() {
       dbuga('iosStreamAudio emptied');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("error", function() {
       dbuga('iosStreamAudio error');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("pause", function() {
       dbuga('iosStreamAudio pause');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("seeking", function() {
       dbuga('iosStreamAudio seeking');
       //if(uiPlaying){connectStream();}
    }, false);
    iosStreamAudio.addEventListener("ended", function() {
       dbuga('iosStreamAudio ENDED');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("stalled", function() {
       dbuga('iosStreamAudio stalled so ');
       iosStreamPlaying =false;
       streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("waiting", function() {
       waitEvents++;
       dbuga('iosStreamAudio WAITING '+waitEvents);
       if(waitEvents>3){
         togglePlaying();
         window.setTimeout("togglePlaying()", 1000);
       }
       //iosStreamPlaying=false;
       //streamPlaying=false;
    }, false);
    iosStreamAudio.addEventListener("play", function() {
       dbuga('iosStreamAudio PLAY');
       //iosStreamPlaying=false;
       //streamPlaying=false;
    }, false);

    iosStreamAudio.addEventListener("playing", function() {
       dbuga('iosStreamAudio PLAYING so streamPlaying=true');
       iosStreamPlaying = true;
       
       streamPlaying = true;
       buttonOn("listen", "playpause");
       retrying=false;
       updateNowPlaying();
       singing=false;
       //minuteTick();
    }, false);

    }
  streamCreated=true;
  }

function playStream(){
  dbuga('playStream() ios='+ios+" streamCreated:"+streamCreated);
  if(streamCreated==false){createStream();}
  //stopStream();
  if(android){
    //dbuga("androidStreamMedia.play()");
    stopStream();
    androidStreamMedia.play();
    }
  if(ios){
    iosStreamAudio.play();
    //connectStream();
    }
  }
function androidStatusCallback(theStatus){
  var prevStatus=androidStreamStatus;
  androidStreamStatus=theStatus;
  dbuga('androidStatusCallback '+theStatus+" "+statusArray[theStatus] +" prevStatus:"+prevStatus);
  if(androidStreamStatus==2){
    androidStreamPlaying=true;
    streamPlaying=true;
    singing=false;
    retrying=false;
    uiPlaying=true;
    stateMessage="Streaming...";
    if(prevStatus==1){updateNowPlaying();}    
    }
  else{
    androidStreamPlaying=false;
    streamPlaying=false;
    }
  if((uiPlaying)&&(androidStreamStatus==4)&&(prevStatus==2)){
    // interrupted
    stateMessage="Interrupted, retrying...";
    startRetrying();
    }
  }

function androidError(er){
  //dbuga("androidError "+JSON.stringify(er))
  }
function androidSuccess(){
  //dbuga('androidSuccess');
  }


function retryTick(){
  if(retrying==true){
    if((retryAttempts>10)&&(retryAttempts%5==0)){
      stateMessage="Retrying...";
      }
    else{
      stateMessage="";
      }
    dbuga(" retryTick() streamPlaying="+ streamPlaying);
    retryAttempts++;

    if(streamPlaying==false){
      if(ios){
        if(iosStreamAudio.readyState==4){
          //window.setTimeout("playStream()", 3000);
          playStream();
          }
        ////createStream();
        }
      if(android){
        window.setTimeout("playStream()", 5000);
        createStream();
        }
      ////singing=false;
      }
    if(retryAttempts>20){
      connectionMessage="We're not connecting.<br />Try again in a bit K?";
      stateMessage="";
      if(singing){singMedia.play();}
      
      uiPlaying=false;
      retrying=false;
      buttonOff("listen", "playpause");      
      }
    }
  }
function readyStateDisplay(readyState){
  readyState=Number(readyState);
  var readyString="";
  for(var r=0; r<readyState; r++){readyString+="&nbsp;*";}
  if(debugging){document.getElementById("readyStateDiv").innerHTML=readyString;}
  }
function stateTick(){
  if(ios){
    readyStateDisplay(iosStreamAudio.readyState);
    }
  if(android){
    //readyStateDisplay(androidStreamMedia.readyState);// need to set listener?
    }
  
  // lost a connection?
  var wasConnected=connection;
  if((navigator.connection.type ==Connection.NONE)||(navigator.connection.type =="none")){
    connection=false;
    connectionMessage="Try again later...we are not connecting.";
    }
  else{
    connection=true;
    //connectionMessage=navigator.connection.type +" connection";
    connectionMessage="";
    }
  if(connection==false){ // not connected
    if(wasConnected==true){
      //dbuga('Lost connection');
      connectionMessage="Lost connection...";
      if(ios){
        if(uiPlaying){
          streamPlaying=false;
          iosStreamPlaying=false;
          //startRetrying();
          }
        }
      }
    // always update state if no connection
    document.getElementById('page_listen_content_nowPlayingDiv').innerHTML=stateMessage;
    document.getElementById('page_listen_content_djDiv').innerHTML=connectionMessage;
    }
  else{// is connected
    if(wasConnected==false){
      dbuga('reconnected so create stream then retry in one sec retrying='+retrying);
      createStream();////
      if(uiPlaying){
        window.setTimeout("startRetrying()", 5000);
        }
      //update because connection restored on this tick
      document.getElementById('page_listen_content_nowPlayingDiv').innerHTML=stateMessage;
      document.getElementById('page_listen_content_djDiv').innerHTML=connectionMessage;
      }
    }
  if((uiPlaying)&&(streamPlaying==false)){
    if(stateMessage != ""){
      document.getElementById('page_listen_content_nowPlayingDiv').innerHTML=stateMessage;
      document.getElementById('page_listen_content_djDiv').innerHTML=connectionMessage;
      }
    }
  debugState();
  }
function debugState(){
  if(debugging==false){
    document.getElementById("stateDiv").style.display="none";
    }
  else{
    var stateDiv=document.getElementById("stateDiv");
    stateDiv.style.display="block";
 
    stateDiv.innerHTML=""+rnd(210)+"<br />";
    
    stateDiv.innerHTML+="navigator.connection.type="+navigator.connection.type+"<br />";
    stateDiv.innerHTML+="waitEvents="+waitEvents+"<br />";
    //stateDiv.innerHTML+="connection="+connection+"<br />";
    //stateDiv.innerHTML+="stateMessage="+stateMessage+"<br />";
    //stateDiv.innerHTML+="connectionMessage="+connectionMessage+"<br />";
    stateDiv.innerHTML+="retrying="+retrying+"<br />";
    stateDiv.innerHTML+="retryAttempts="+retryAttempts+"<br />";

    if(android){
      //stateDiv.innerHTML+="android="+android+"<br />";
      stateDiv.innerHTML+="androidStreamPlaying="+ androidStreamPlaying + "<br />";
      stateDiv.innerHTML+="androidStreamStatus="+ androidStreamStatus + "<br />";
      }
    if(ios){
      //stateDiv.innerHTML+="ios="+ios+"<br />";
      stateDiv.innerHTML+="iosStreamAudio.readyState="+iosStreamAudio.readyState+"<br />";
      stateDiv.innerHTML+="iosStreamPlaying="+iosStreamPlaying+"<br />";
      }
    stateDiv.innerHTML+="uiPlaying="+uiPlaying+"<br />";
    stateDiv.innerHTML+="streamPlaying="+streamPlaying+"<br />";
    stateDiv.innerHTML+="streamCreated="+ streamCreated +"<br />";
    stateDiv.innerHTML+="myStreamUrl ="+ myStreamUrl +"<br />";

  
    stateDiv.innerHTML+="singing="+singing+"<br />";
    stateDiv.innerHTML+="singStatusNum="+singStatusNum+"<br />";
    }
  }
// -------------- events --------------------
function mediumSelected(){
  buttonOn("settings", "medium");
  buttonOff("settings", "higher");
  genericSet("quality", "medium");
  stopStream();
  createStream();
  if(uiPlaying){
    startRetrying();
    }
  }
function highSelected(){
  buttonOff("settings", "medium");
  buttonOn("settings", "higher");
  genericSet("quality", "higher");
  stopStream();
  connectStream();
  if(uiPlaying){
    startRetrying();
    }
  }
function startRetrying(){
  dbuga('startRetrying()');
  if(android){createStream();}
  clearInterval(retryInterval);
  if(ios){
    retryTick();
    //////retryInterval=window.setInterval("retryTick()", 1000);
    }
  if(android){
    retryInterval=window.setInterval("retryTick()", 15000);
    }
  clearInterval(minuteInterval);
  minuteInterval=setInterval('minuteTick()', minuteMs);
  retrying=true;
  retryAttempts=0;
  retryTick();
  //stateMessage="Starting...";
  connectionMessage="";
  }
function togglePlaying(){
  dbuga('togglePlaying() uiPlaying='+uiPlaying);
  //document.getElementById('page_listen_content_nowPlayingDiv').innerHTML="";
  if(uiPlaying==true){
    uiPlaying=false;
    retrying=false;
    buttonOff("listen", "playpause");
    stopStream();
    document.getElementById('page_listen_content_nowPlayingDiv').innerHTML="";
    }
  else{
    buttonOn("listen", "playpause");
    document.getElementById('page_listen_content_nowPlayingDiv').innerHTML="Connecting...";
    uiPlaying=true;
    playStream();
  
    //startRetrying();
    }
  document.getElementById('page_listen_content_djDiv').innerHTML="";
  }


// ----------------------------------------------------------------------------
function genericDefault(itemName, defaultValue){
  //if(android){
    if (localStorage.getItem(itemName) === null) {
      localStorage.setItem(itemName, defaultValue);
      }
  //  }
  }
function genericSet(itemName, newValue){
  //if(android){
    localStorage.setItem(itemName, newValue);
  //  }
  }
function genericGet(itemName){
  var value="notSet";
  //if(android){
    value=localStorage.getItem(itemName);
  //  }
  var valueNumber=Number(value);
  var valueNumberString=""+valueNumber+"";
  if(value==valueNumberString){
    value=Number(value);
    //dbuga(itemName+" is a Number");
    }
  else{
    //dbuga(itemName+" is a String");
    }
  
  return value;
  }
var readyTimeout;
var minuteInterval;
var dimensionInterval;
function init(){
  document.addEventListener("deviceready", onDeviceReady, false);
  readyTimeout=window.setTimeout("onDeviceReady()", 5000);
  }
function onDeviceReady(){
  clearTimeout(readyTimeout);
  //dbuga("onDeviceReady() device.platform="+device.platform);
  if (device.platform == "Android") {
    android=true;
    }
  if (device.platform == "iOS") {
    ios=true;
    }
  if (device.platform == "browser") {
    
    }
  if(android){returnFalse=" return false;";}

  if(android){ 
    singMedia = new Media("/android_asset/www/sounds/singing.mp3", singSuccess, singError, singStatusCallback);
    }
  if(ios){
    singMedia = new Media("sounds/singing.mp3", singSuccess, singError, singStatusCallback);
    }
  //dbuga("onDeviceReady() completed");
  resumeInit();
  }
var allowAjax=true;
function resumeInit(){
  //dbuga('init 0.0');
  currentPage="listen";

  populateContainer();
  genericDefault("alarmMinuteOfDay", 11*60+30);
  genericDefault("sleepMinutesDefault", 10);
  genericDefault("quality", "higher");

  buttonOn("settings", genericGet("quality"));
  buttonOn("footnav", "listen");
  //dbuga(' init 3');
  clearInterval(minuteInterval);
  minuteInterval=setInterval('minuteTick()', minuteMs);
  dialInterval=setInterval('dialTick()', 25);
  //dbuga(' init 4');
  //minuteTick();
  getFaqs();
  //dbuga(' init 5');
  //retryInterval=window.setInterval("retryTick()", 15000);    

  selectPage("listen");
  document.addEventListener("backbutton", onBackKeyDown, false);
  //dbuga(' init 7');
  getRecentSong();

  //document.addEventListener("offline", onOffline, false);
  //document.addEventListener("online", onOnline, false);
  //dbuga(' init 7');
  myStreamUrl = urlByQuality[genericGet("quality")]+"";
  //dbuga(' init 7');
  //////if(ios){createStream();}
  //dbug('init okay');
  }

function onOffline() {
  //dbuga('onOffline() uiPlaying='+uiPlaying);
  }
var returnFalse="";
function onOnline() {
  //dbuga('onOnline() uiPlaying='+uiPlaying);
  if(uiPlaying){
    }
  }
var statusArray=['MEDIA_NONE', 'MEDIA_STARTING', 'MEDIA_RUNNING', 'MEDIA_PAUSED', 'MEDIA_STOPPED'];
function singStatusCallback(theStatus){
  singStatusNum=theStatus;
  //dbuga('singMedia status '+theStatus+" "+statusArray[theStatus]+" singing="+singing);
  if((theStatus==4)&&(singing==true)){
    singMedia.play();
    }
  }
function singError(er){
  //dbuga("singError "+JSON.stringify(er))
  }
function singSuccess(){
  //dbuga('singSuccess');
  //singMedia.play();
  }
 document.addEventListener("backbutton", onBackKeyDown, false);
  
function onBackKeyDown() {
  // Handle the back button
      selectPage("listen");
      buttonOn("footnav", "listen");
      buttonOff("footnav", "request");
  }

var songs=[];

var secondInterval;
var sleepSeconds=0;
var dialInterval;

function getRecentSong(){
  dbuga('getRecentSong()');
  //return false;
  var feedUrl="http://www.radiok.org/tools/packages/radiok/recent_song";
  if(allowAjax){
      $.ajax({
      url: feedUrl,
      dataType: "text",        //  new bit
      success: function(data) {parseRecentSong(data);}
      });
    }
  }
function getRecentSongs(){
  dbuga('getRecentSongs()');
  //return false;
  //var feedUrl="http://www.radiok.org/";
  var feedUrl="http://www.radiok.org/tools/packages/radiok/recent_songs";
  //var feedUrl="recent_songs.txt";
  if(allowAjax){
      $.ajax({
      url: feedUrl,
      dataType: "text",        //  new bit
      success: function(data) {parseRecentSongs(data);}
      });
    }
  }
// remove errors on publish
function replaceAll(find, replace, str) {
  var parts=str.split(find);
  return parts.join(replace);
}
function parseRecentSongs(theData){
  recentSongs=JSON.parse(theData);
  var songKeys=Object.keys(recentSongs);
  dbuga("parseRecentSongs("+songKeys.length+")");
  songKeys.sort();
  songKeys.reverse();
  if(songKeys.length>0){
    var album=recentSongs[songKeys[0]].song_album;
    var song=recentSongs[songKeys[0]].song_title;
    var artist=recentSongs[songKeys[0]].song_artist;
    var time=recentSongs[songKeys[0]].song_timestamp;
    var dj=recentSongs[songKeys[0]].dj;
    if(song.indexOf("'")>-1){
      song = replaceAll("'", "&apos;", song);
      }
    nowData={"dj":dj, "time":time, "artist":artist, "song":song, "album":album};
    }
  updatePlaylist();
  }
var recentSong={};
var nowData={"dj":"", "time":"", "artist":"", "song":"", "album":""};
var recentSongs={};
var testData="";
/*
{
"553732":{
  "song_id":"553732",
  "song_timestamp":"2015-03-16 09:28:31",
  "song_artist":"Homeless & Big Cats",
  "song_title":"Forklifts",
  "song_album":"Single",
  "song_length":"3:00",
  "dj":"Michael L",
  "show_name":"Monday 9-12pm",
  "disk_id":"39766",
  "playlist_id":"8690",
  "show_category":"Variety Shift"
  }
}
*/
function parseRecentSong(theData){
  testData=theData;
  recentSong=JSON.parse(theData);
  var songKeys=Object.keys(recentSong);
  dbuga("parseRecentSong("+songKeys.length+")");

  songKeys.sort();
  songKeys.reverse();
  if(songKeys.length>0){
    //dbuga("songKeys[0]="+songKeys[0]);
    var album=recentSong[songKeys[0]].song_album;
    var song=recentSong[songKeys[0]].song_title;
    //dbuga("song="+song);
    var artist=recentSong[songKeys[0]].song_artist;
    //dbuga("artist="+artist);
    var time=recentSong[songKeys[0]].song_timestamp;
    var dj=recentSong[songKeys[0]].dj;
    //dbuga("dj="+dj);
    if(song.indexOf("'")>-1){
      song = replaceAll("'", "&apos;", song);
      }
    nowData={"dj":dj, "time":time, "artist":artist, "song":song, "album":album};
    //dbuga("uiPlaying ="+ uiPlaying);
    //dbuga("streamPlaying ="+ streamPlaying);
    if((uiPlaying==true)&&(streamPlaying==true)){
      updateNowPlaying();
      }
    }
  }
var totdDownloads=[];
var wrsDownloads=[];
var cqDownloads=[];
var spotlightImage="";
function getDownloads(){
  //dbuga("getDownloads()");
  totdDownloads=[];
  wrsDownloads=[];
  cqDownloads=[];
  document.getElementById('totdHolder').style.width=grid*48+'px'; 
  document.getElementById('totdHolder').style.height=grid*51+'px'; 
  document.getElementById('wrsHolder').style.width=grid*48+'px'; 
  document.getElementById('wrsHolder').style.height=grid*51+'px'; 
  document.getElementById('cqHolder').style.width=grid*48+'px'; 
  document.getElementById('cqHolder').style.height=grid*51+'px'; 
  totdDownloads=[];
  wrsDownloads=[];
  cqDownloads=[];

  $.ajax({
    url: "http://www.radiok.org/tools/packages/page_list_teasers/podcast_rss?path=%2Ffeatures%2Fweekly-release-spotlight%2F",
    dataType: "xml",        
    success: function(xml) {parseDownloads(xml, "Weekly Release Spotlight");}
    });
  $.ajax({
    url: "http://www.radiok.org/tools/packages/page_list_teasers/podcast_rss?path=%2Ffeatures%2Fculture-queue%2F",
    dataType: "xml",        
    success: function(xml) {parseDownloads(xml, "Culture Queue");}
    });
  $.ajax({
    url: "http://www.radiok.org/tools/packages/page_list_teasers/podcast_rss?path=%2Ffeatures%2Ftotd",
    dataType: "xml",        
    success: function(xml) {parseDownloads(xml, "Track of the Day");}
    });





  }
var dbugItem="";
// remove errors on publish
var monToMM={"Jan":"01", "Feb":"02", "Mar":"03", "Apr":"04", "May":"05", "Jun":"06", "Jul":"07", "Aug":"08", "Sep":"09", "Oct":"10", "Nov":"11", "Dec":"12"};
var monToMonth={"Jan":"January", "Feb":"February", "Mar":"March", "Apr":"April", "May":"May", "Jun":"June", "Jul":"July", "Aug":"August", "Sep":"September", "Oct":"October", "Nov":"November", "Dec":"December"};
function parseDownloads(theXml, source){
  //dbuga("parseDownloads() "+source);
  if(source=="Track of the Day"){
    var totdObj=xmlToJson(theXml);
    var itemsArray=totdObj.rss.channel.item;
    //dbug('itemsArray.length='+itemsArray.length);
    for (var i=0; (i<itemsArray.length)&&(i<14); i++){
      var thisObj=itemsArray[i];
      var dateStr=thisObj.pubDate["#text"];
      var parts=dateStr.split(" ");
      var yyyy=parts[3];
      var mm=monToMM[parts[2]];
      var dd=parts[1];
      var timeCode=parts[4];
      var timeParts=timeCode.split(":");
      var hhmmss=timeParts[0]+timeParts[1]+timeParts[2];
      var sortNum=yyyy+mm+dd+hhmmss;
      var dispDate=monToMonth[parts[2]]+" "+Number(parts[1]);
      var bandSong=thisObj.title["#text"];
      var parts=bandSong.split(" - ");
      var band=parts[0];
      var song=parts[1];
      var item={
        "sort":sortNum, 
        "source":source, 
        "date":dispDate, 
        "image":thisObj["itunes:image"]["@attributes"]["href"], 
        "title":band,
        "description":song, 
        "link":thisObj["enclosure"]["@attributes"]["url"]
        };
      totdDownloads.push(item);
      }
    updateTotdDownloads();
    }
  if(source=="Culture Queue"){
    var cqObj=xmlToJson(theXml);
    //dbugItem=cqObj;
    var itemsArray=cqObj.rss.channel.item;
    //dbug('itemsArray.length='+itemsArray.length);
    for (var i=0; (i<itemsArray.length)&&(i<14); i++){
      var thisObj=itemsArray[i];
      var dateStr=thisObj.pubDate["#text"];
      var parts=dateStr.split(" ");
      var yyyy=parts[3];
      var mm=monToMM[parts[2]];
      var dd=parts[1];
      var timeCode=parts[4];
      var timeParts=timeCode.split(":");
      var hhmmss=timeParts[0]+timeParts[1]+timeParts[2];
      var sortNum=yyyy+mm+dd+hhmmss;
      var dispDate=monToMonth[parts[2]]+" "+Number(parts[1]);
      var title=thisObj.title["#text"];
      var item={
        "sort":sortNum, 
        "source":source, 
        "date":dispDate, 
        "image":thisObj["itunes:image"]["@attributes"]["href"], 
        "title":"",
        "description":title, 
        "link":thisObj["enclosure"]["@attributes"]["url"]
        };
      cqDownloads.push(item);
      }
    updateCqDownloads();
    }
  if(source=="Weekly Release Spotlight"){
    var wrsObj=xmlToJson(theXml);
    var itemsArray=wrsObj.rss.channel.item;
    //dbug('itemsArray.length='+itemsArray.length);
    for (var i=0; (i<itemsArray.length)&&(i<14); i++){
      var thisObj=itemsArray[i];
      var dateStr=thisObj.pubDate["#text"];
      var parts=dateStr.split(" ");
      var yyyy=parts[3];
      var mm=monToMM[parts[2]];
      var dd=parts[1];
      var timeCode=parts[4];
      var timeParts=timeCode.split(":");
      var hhmmss=timeParts[0]+timeParts[1]+timeParts[2];
      var sortNum=yyyy+mm+dd+hhmmss;
      var dispDate=monToMonth[parts[2]]+" "+Number(parts[1]);
      var band=thisObj.title["#text"];
      var album=thisObj.description["#text"];
      var link=thisObj.link["#text"];
      var item={
        "sort":sortNum, 
        "source":source, 
        "date":dispDate, 
        "image":thisObj["itunes:image"]["@attributes"]["href"], 
        "title":band,
        "description":album, 
        "link":link
        };
      wrsDownloads.push(item);
      }
    updateWrsDownloads();
    }
  }
function xmlToJson(xml) {
  
  // Create the return object
  var obj = {};

  if (xml.nodeType == 1) { // element
    // do attributes
    if (xml.attributes.length > 0) {
    obj["@attributes"] = {};
      for (var j = 0; j < xml.attributes.length; j++) {
        var attribute = xml.attributes.item(j);
        obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
      }
    }
  } else if (xml.nodeType == 3) { // text
    obj = xml.nodeValue;
  }

  // do children
  if (xml.hasChildNodes()) {
    for(var i = 0; i < xml.childNodes.length; i++) {
      var item = xml.childNodes.item(i);
      var nodeName = item.nodeName;
      if (typeof(obj[nodeName]) == "undefined") {
        obj[nodeName] = xmlToJson(item);
      } else {
        if (typeof(obj[nodeName].push) == "undefined") {
          var old = obj[nodeName];
          obj[nodeName] = [];
          obj[nodeName].push(old);
        }
        obj[nodeName].push(xmlToJson(item));
      }
    }
  }
  return obj;
};

function updateWrsDownloads(){
  //dbuga('updateWrsDownloads()');
  var sortedDownloads=wrsDownloads.sort(function(a, b){
      // furthest to nearest
      return b.sort-a.sort
    });

  var gradStyle=returnGradStyle();
  var textStyle='padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*8 +'px;  line-height:'+ grid*2.5 +'px;'
  spotlightImage=sortedDownloads[0].image;
  //dbuga("spotlightImage="+spotlightImage);
  document.getElementById("page_extras_button_wrs").style.backgroundImage='url('+spotlightImage+')';
  document.getElementById("page_extras_button_wrs_on").style.backgroundImage='url('+spotlightImage+')';

  var htmlBlock="";
  for(var d=0; d<sortedDownloads.length; d++){
    var downloadItem=sortedDownloads[d];
    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+=  '<a href="javascript:remoteLink(\''+downloadItem.link+'\');'+returnFalse+'"><img src="'+downloadItem.image+'" style="position:absolute; left:'+grid*1+'px; width:'+grid*7 +'px; height:'+grid*7 +'px;" /></a>';
    htmlBlock+=  '<div style="position:absolute; left:'+grid*10+'px; height:'+grid*8+'px; border:0px solid black; width:'+grid*34+'px; Zbackground-color:blue;">'
    if(downloadItem.source != "skip"){    htmlBlock+=  ''+downloadItem.source+' ';}
    if(downloadItem.date != "skip"){htmlBlock+=  '<br />'+downloadItem.date+' ';}
    htmlBlock+=  ' <a href="javascript:remoteLink(\''+downloadItem.link+'\');'+returnFalse+'">'+downloadItem.title+' - '+downloadItem.description+'</a>';
    htmlBlock+='</div></div>';
    }
  document.getElementById('wrsScroller').innerHTML=htmlBlock;
  document.getElementById('wrsHolder').style.width=grid*48+'px'; 
  document.getElementById('wrsHolder').style.height=grid*51+'px'; 
  //wrsScrollerTimeout=window.setTimeout("refreshWrsHolderScroll()", 100);
  }

//var wrsScrollerTimeout;
/*
function refreshWrsHolderScroll(){
  wrsHolderScroll.refresh();
  }
var wrsHolderScroll;
*/

function updateTotdDownloads(){
  //dbuga('updateTotdDownloads()');
  var sortedDownloads=totdDownloads.sort(function(a, b){
      // furthest to nearest
      return b.sort-a.sort
    });

  var gradStyle=returnGradStyle();
  var textStyle='padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*8 +'px;  line-height:'+ grid*2.5 +'px;'
  var htmlBlock="";
  for(var d=0; d<sortedDownloads.length; d++){
    var downloadItem=sortedDownloads[d];
    if(d==0){
      document.getElementById("page_extras_button_totd").style.backgroundImage='url('+downloadItem.image+')';
      document.getElementById("page_extras_button_totd_on").style.backgroundImage='url('+downloadItem.image+')';
      }
    //dbuga(downloadItem.link);
    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+=  '<a href="javascript:remoteLink(\''+downloadItem.link+'\');'+returnFalse+'"><img src="'+downloadItem.image+'" style="position:absolute; left:'+grid*1+'px; width:'+grid*7 +'px; height:'+grid*7 +'px;" /></a>';
    htmlBlock+=  '<div style="position:absolute; left:'+grid*10+'px; height:'+grid*8+'px; border:0px solid black; width:'+grid*34+'px; Zbackground-color:blue;">'
    if(downloadItem.source != "skip"){    htmlBlock+=  ''+downloadItem.source+' ';}
    if(downloadItem.date != "skip"){htmlBlock+=  ' - '+downloadItem.date+'<br />';}
    htmlBlock+=  downloadItem.title+' - <a href="javascript:remoteLink(\''+downloadItem.link+'\');'+returnFalse+'">'+downloadItem.description+'</a>';
    htmlBlock+='</div></div>';
    }
  document.getElementById('totdScroller').innerHTML=htmlBlock;
  document.getElementById('totdHolder').style.width=grid*48+'px'; 
  document.getElementById('totdHolder').style.height=grid*51+'px'; 
  //totdScrollerTimeout=window.setTimeout("refreshTotdHolderScroll()", 100);
  }
/*
var totdScrollerTimeout;
function refreshTotdHolderScroll(){
  totdHolderScroll.refresh();
  }
var totdHolderScroll;
*/

function returnGradStyle(){
  var gradStyle="background-image: -webkit-gradient(linear,left top,left bottom, color-stop(0%, #F2F2F2), color-stop(2%, #F2F2F2), color-stop(3%, #EDEDED), color-stop(50%, #fff), color-stop(100%, #fff));";
  //gradStyle="";// hack to test speed
  return gradStyle;
  }
function updateCqDownloads(){
  //dbuga('updateCqDownloads()');
  var sortedDownloads=cqDownloads.sort(function(a, b){
      // furthest to nearest
      return b.sort-a.sort
    });
  var gradStyle=returnGradStyle();
  var textStyle='padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*8 +'px;  line-height:'+ grid*2.5 +'px;'
  cqDownloads=sortedDownloads;
  var htmlBlock="";
  for(var d=0; d<sortedDownloads.length; d++){
    var downloadItem=sortedDownloads[d];
    if(d==0){
      document.getElementById("page_extras_button_cq").style.backgroundImage='url('+downloadItem.image+')';
      document.getElementById("page_extras_button_cq_on").style.backgroundImage='url('+downloadItem.image+')';
      }
    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+='<a href="javascript:remoteCqLink(\''+d+'\');'+returnFalse+'">';
    htmlBlock+=  '<img src="'+downloadItem.image+'" style="position:absolute; left:'+grid*1+'px; width:'+grid*7 +'px; height:'+grid*7 +'px;" />';
    htmlBlock+='</a>';
    htmlBlock+=  '<div style="position:absolute; left:'+grid*10+'px; height:'+grid*8+'px; border:0px solid black; width:'+grid*34+'px; Zbackground-color:blue;">'
    //htmlBlock+=  downloadItem.title+'<br />';
    if(downloadItem.source != "skip"){    htmlBlock+=  ''+downloadItem.source+' ';}
    if(downloadItem.date != "skip"){htmlBlock+=  ' - '+downloadItem.date+'<br />';}
    htmlBlock+='<a href="javascript:remoteLink(\''+downloadItem.link+'\');'+returnFalse+'">'+downloadItem.description+'</a>';
    htmlBlock+='</div></div>';
    if(d>9){d=sortedDownloads.length;}
    }
  document.getElementById('cqScroller').innerHTML=htmlBlock;
  document.getElementById('cqHolder').style.width=grid*48+'px'; 
  document.getElementById('cqHolder').style.height=grid*51+'px'; 
  //cqScrollerTimeout=window.setTimeout("refreshCqHolderScroll()", 100);
  }
/*
var cqScrollerTimeout;
function refreshCqHolderScroll(){
  cqHolderScroll.refresh();
  }
var cqHolderScroll;
*/

function updateNowPlaying(){
  //dbuga('updateNowPlaying()')
  if((connection)&&(uiPlaying)){
    document.getElementById('page_listen_content_nowPlayingDiv').innerHTML=nowData.artist+"<br>"+nowData.song+"<br>"+nowData.album;  
    document.getElementById('page_listen_content_djDiv').innerHTML="DJ: "+nowData.dj;  
    //if(ios){nowPlaying.updateMetas(nowData.artist,nowData.song,nowData.dj);}
    }
  }
function dateTimeToTime(theDateTime){
  var parts=theDateTime.split(" ");
  var timePart=parts[1];
  var hms=timePart.split(":");
  var hour=Number(hms[0]);
  var minute=hms[1];
  var period="am";
  if(hour>12){
    hour-=12;
    period="pm";
    }
  var textTime=hour+":"+minute+" "+period;
  return textTime;
  }
function updatePlaylist(){
  //dbuga('updatePlaylist()');
  var songKeys=Object.keys(recentSongs);
  songKeys.sort();
  songKeys.reverse();
  var gradStyle=returnGradStyle();

  var textStyle='padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*8 +'px;  line-height:'+ grid*2.5 +'px;'
  var htmlBlock="";

  for(var s=0; s<songKeys.length; s++){
    var songData=recentSongs[songKeys[s]];
    var song=songData.song_title;
    var artist=songData.song_artist;
    var album=songData.song_album;
    if(song.indexOf("'")>-1){song = replaceAll("'", "", song);}
    if(artist.indexOf("'")>-1){artist = replaceAll("'", "", artist);}
    if(album.indexOf("'")>-1){album = replaceAll("'", "", album);}

    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+=  ''+artist+' &#8220;'+song+'&#8221;';
    htmlBlock+=  '<br /><a href="javascript:shop(\''+artist+'\', \''+album+'\', \''+song+'\');">';
    htmlBlock+=  ''+album+'</a>';
    htmlBlock+=  '<br /><span style="font-family:akziregular;">'+dateTimeToTime(songData.song_timestamp)+'</span>';
    htmlBlock+='</div>';
    }
  if(songKeys.length==0){
    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+=  'Stuck on AM Mix';
    htmlBlock+=  '<br /><span style="font-family:akziregular;">Live Performances from Radio K</span>';
    htmlBlock+='</div>';
   }

  document.getElementById('playlistScroller').innerHTML=htmlBlock; 
  document.getElementById('playlistHolder').style.width=grid*48+'px'; 
  document.getElementById('playlistHolder').style.height=grid*51+'px'; 
  //playlistScrollerTimeout=window.setTimeout("refreshPlaylistHolderScroll()", 100);
  }

function populateCalendar(){
  //dbuga('populateCalendar() '+calendar.length);

  var gradStyle=returnGradStyle();

  var textStyle='padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*8 +'px;  line-height:'+ grid*2.5 +'px;'
  var htmlBlock="";
//<a href="javascript:remoteLink('" +="" eventdata.url="" +"');"="">Drone Not Drones</a>
  for(var e=0; e<calendar.length; e++){
    var eventData=calendar[e];
    htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
    htmlBlock+=  '<a href="javascript:remoteLink(\''+ eventData.url +'\');">'+eventData.performers+'</a>';
    htmlBlock+=  '<br />'+eventData.venue+'';
    htmlBlock+=  ' &mdash; '+eventData.date;
    htmlBlock+=  '<br /><span style="font-family:akziregular;">'+eventData.time+'</span>';
    htmlBlock+='</div>';
    }

  document.getElementById('calendarScroller').innerHTML=htmlBlock; 
  document.getElementById('calendarHolder').style.width=grid*48+'px'; 
  document.getElementById('calendarHolder').style.height=grid*51+'px'; 
  }
function getFaqs(){
  faqs=[];
  var feedUrl="http://www.radiok.org/app-faq/";
  //var feedUrl="app-faq.txt";
  //dbuga('getFaqs()');
  $.ajax({
    url: feedUrl,
    dataType: "text",        // < new bit
    success: function(data) {parseFaqs(data);}
    });
  //dbuga('getFaqs() completed');
  }
var faqs=[
  {"q":"What is Radio K?", "a":"Radio K, the award-winning radio station of the University of Minnesota, is nationally recognized as one of the best student-run college radio stations in the country, playing an eclectic variety of independent music both old and new.<br /><br />Radio K educates students, breaks ground in musical programming, and provides cutting-edge cultural coverage through our specialty shows, web content and Culture Queue."},
  {"q":"How can I contact Radio K?", "a":"Email: <a href=\"mailto:radiokdj@umn.edu\">radiokdj@umn.edu</a><br /><br />Phone: <a href=\"tel:+16126253500\">612-625-3500</a><br /><br />Web: <a href=\"http://www.radiok.org/\">www.radiok.org</a><br /><br />Mobile:<br /><a href=\"http://twitter.com/radiok\"><img src=\"social/twitter.png\" width=\"socialSize\" height=\"socialSize\" /></a> <a href=\"https://www.facebook.com/20658369592\"><img src=\"social/facebook.png\" width=\"socialSize\" height=\"socialSize\" /></a> <a href=\"http://www.youtube.com/user/RadioK770?feature=watch\"><img src=\"social/youtube.png\" width=\"socialSize\" height=\"socialSize\" /></a> <a href=\"https://plus.google.com/u/0/106019319997650127214/about\"><img src=\"social/googleplus.png\" width=\"socialSize\" height=\"socialSize\" /></a> <a href=\"http://www.radiok.org/blogs/new/tag/track%20of%20the%20day\"><img src=\"social/rss.png\" width=\"socialSize\" height=\"socialSize\" /></a>"},
  {"q":"How can I keep Radio K playing music?","a":"You can keep your already rad support going by <a href=\"http://www.radiok.org/donate/\">donating</a> to the station and becoming a member. And, we like to keep it chill so donating literally any amount makes you a member. Got a spare $10? Throw it our way and we can keep the CDs spinning."},
  {"q":"How do I get my band's music on Radio K?","a":"Head over to <a href=\"http://www.radiok.org/about/contact-information/music-submissions/\">RadioK.org</a>"},
  {"q":"How can I download the Track of the Day?","a":"Radio K\'s Track of the Day can be found <a href=\"http://www.radiok.org/blogs/new/tag/track%20of%20the%20day\">here</a>."},
  {"q":"What cool things do you have going on?","a":"We love live music even more than we love recorded music&mdash;check out our <a href=\"http://www.radiok.org/events/\">Events Calendar</a>."},
  {"q":"When is that awesome local show,<br>Off The Record?","a":"Off The Record is every Friday from 3 p.m. to 5 p.m. CST. Local music and local trivia comin&apos; at you for two hours, not to mention an interview and studio session with a local band during each show!"},
  {"q":"You wanna be a DJ, too?","a":"University of Minnesota student taking 1 credit or more? If so then just email <a href=\"mailto:volunteer@radiok.org\">volunteer@radiok.org</a> and you&apos;ll be on your way to becoming a rich, fabulous, glamorous DJ. (OK, we know those adjectives are, like, kind of an exaggeration but whatever, right?)"},
  {"q":"Your Mom listens to commercial radio.<br>What&apos;s the deal with that?","a":"You heard wrong&mdash;our moms totally listen to us. They appreciate the fact that we&apos;re trying to keep &apos;em \"hip and groovy\" (their words, not ours). Real College Radio is for the cutting edge, the risk takers, the people who know that music matters most. That&apos;s you. That&apos;s us. That&apos;s them&mdash;&apos;cause we&apos;ve taught our mothers well."}
];
function parseFaqs(theScrape){
  var faqBlocks=theScrape.split('<div class="faq_item">');
  //dbuga('parseFaqs faqBlocks.length=' +faqBlocks.length);
  if(faqBlocks.length>1){
    faqs=[];
    for (var s=1; s<faqBlocks.length; s++){
      var faqBlock=faqBlocks[s];
      var headingTempParts=faqBlock.split('<div class="faq_heading"><h2>');
      var headingTemp=headingTempParts[1];
      var headingParts=headingTemp.split('</h2></div>');
      var headingText=headingParts[0];

      var contentTempParts=faqBlock.split('<div class="faq_content"><p>');
      var contentTemp=contentTempParts[1];
      var contentParts=contentTemp.split('</p></div>');
      var contentText=contentParts[0];
      var thisEntry={"q":headingText, "a":contentText};
      faqs.push(thisEntry);
      //dbuga('<h2>'+headingText+'</h2><p>'+contentText+'</p>');
      }
    }
  populateFaqs();
  }
var calendar=[];
function getCalendar(){
  calendar=[];
  var feedUrl="http://www.radiok.org/events/";
  //dbuga('getCalendar()');
  $.ajax({
    url: feedUrl,
    dataType: "text",        // < new bit
    success: function(data) {parseCalendar(data);}
    });
  //dbuga('getCalendar() completed');
  }


function parseCalendar(theScrape){
  var blocks=theScrape.split('<div class="titlehead">');
  for (var b=1; b<blocks.length; b++){
    var block=blocks[b];
    var timeParts=block.split('<div class="time">');
    var timePlus=timeParts[1];
    var endDivParts=timePlus.split('</div>');
    var time=endDivParts[0];
    var dateLink=endDivParts[1];
    var dateLinkParts=dateLink.split(" - ");
    var date=dateLinkParts[0];
    var link=dateLinkParts[1];
    var linkParts=link.split('"');
    var url='http://radiok.org'+linkParts[1];
    var titleParts=link.split('>');
    var title=titleParts[1];
    titleParts=title.split('<');
    title=titleParts[0];
    var localParts=block.split('<div class="local">');
    var local=localParts[1];
    localParts=local.split('</div>');
    local=localParts[0];
    var rowObj={"date":date, "time":time, "performers":title, "venue":local, "url":url}; 
    calendar.push(rowObj);
    }
  //dbuga('parseCalendar completed');
  populateCalendar();
  }
 

var snoozeMinutes=0;
function secondTick(){
  var nowDate=new Date();
  var nowMod=nowDate.getHours()*60+nowDate.getMinutes();
  var sec=nowDate.getSeconds();
  if(sec<10){sec="0"+sec;}
  var nowText=minuteOfDayToHour(nowMod)+":"+minuteOfDayToMM(nowMod)+":"+sec;//+" "+minuteOfDayToAmPm(nowMod);
  var amPmText=minuteOfDayToAmPm(nowMod);
  if(currentPage=="armed"){
    if(sleepSeconds>0){
      sleepSeconds--;
      var SS=sleepSeconds%60;
      if(SS<10){SS="0"+SS;}
      nowText="-"+Math.floor(sleepSeconds/60)+":"+SS;
      }

    if((nowMod+1440>=genericGet("alarmMinuteOfDay")+1440+snoozeMinutes)&&(nowMod+1440<genericGet("alarmMinuteOfDay")+1500+snoozeMinutes)){

      //    -----    alarming, wake up! --------------

      //dbuga('alarm');
      document.getElementById('page_listen_content_nowPlayingDiv').innerHTML="";
      document.getElementById('page_listen_content_djDiv').innerHTML="";
      buttonOn("listen", "playpause");
      document.getElementById('page_listen_content_djDiv').innerHTML="";
      //dbuga('alarming so singing=true');

      singing=true;
      alarming=true;
      buttonOn("listen", "playpause");
      document.getElementById('page_listen_content_djDiv').innerHTML="Connecting...";
      startRetrying();
      uiPlaying=true;
      selectPage("wakeup");
      }
    }
  document.getElementById("page_armed_content_nowtime").innerHTML=nowText;
  document.getElementById("page_armed_content_nowAmPm").innerHTML=amPmText;
  document.getElementById("page_wakeup_content_nowtime").innerHTML=nowText;
  document.getElementById("page_wakeup_content_nowAmPm").innerHTML=amPmText;
  if((ww!=window.innerWidth)||(wh!=window.innerHeight)){
    clearInterval(secondInterval);
    populateContainer();
    }
  }
function dimensionTick(){
  if((ww!=window.innerWidth)||(wh!=window.innerHeight)){
    clearInterval(dimensionInterval);
    populateContainer();
    }
  stateTick();
  }
var currentPage="";

function selectCurrentPage(){
  selectPage(currentPage);
  }
function minuteOfDayToHH(mod){
  hour=Math.floor(mod/60)%24;
  if(hour<10){hour="0"+hour;}
  return hour;
  }
function minuteOfDayToHour(mod){
  var hr=Math.floor(mod/60)%12;
  if(hr==0){hr=12;}
  return hr;
  }
function minuteOfDayToMin(mod){
  var min=mod%60;
  return min;
  }
function minuteOfDayToMM(mod){
  var min=mod%60;
  if(min<10){min="0"+min;}
  return min;
  }
function minuteOfDayToAmPm(mod){
  var ampm="PM";
  if(Math.floor(mod/60)%12==Math.floor(mod/60)%24){ampm="AM";}
  return ampm;
  }
function minuteOfDayToHalf(mod){
  var ampm=1;
  if(Math.floor(mod/60)%12==Math.floor(mod/60)%24){ampm=0;}
  return ampm;
  }
var dials=[];
function dialTick(){
  //dbug('');
  //dbuga("mouse: "+mouseX+" "+mouseY);

  if(currentPage=="alarm"){
    //dbuga("deltaY: "+(mouseY-mouseStartY));
    updateAlarmDisplay();
    }
  }
var prevDeltaY=0;
function updateAlarmDisplay(){
  var pMod=genericGet("alarmMinuteOfDay");
  //dbug("touchingDial "+touchingDial +" "+minuteOfDayToHour(pMod)+":"+minuteOfDayToMM(pMod)+" "+minuteOfDayToAmPm(pMod));
  var lineHeight=Math.floor(pages[3].contents[0].lineHeight*grid);
  var nowDate=new Date();
  var nowMod=nowDate.getHours()*60+nowDate.getMinutes();
  if(touchingDial>-1){
    var deltaY=(mouseY-mouseStartY);
    var dy=deltaY-prevDeltaY;
    prevDeltaY=deltaY;
    var junk=dials[touchingDial].history.shift();
    dials[touchingDial].history.push(dy);
    dials[touchingDial].atVal=dials[touchingDial].initVal-(deltaY/lineHeight);
    if(dials[touchingDial].atVal>dials[touchingDial].maxVal){dials[touchingDial].atVal=dials[touchingDial].maxVal;}
    if(dials[touchingDial].atVal<0){dials[touchingDial].atVal=0;}

    //dbuga(dials[0].atVal+" "+dials[1].atVal+" "+dials[2].atVal+" "+dials[3].atVal);
    var list=dials[touchingDial].history;
    //dbuga(list.join('|'));
    //dbuga("touchingDial "+touchingDial +" "+minuteOfDayToHour(pMod)+":"+minuteOfDayToMM(pMod)+" "+minuteOfDayToAmPm(pMod));
    }
  else{
    var moved=false;
    // go through moving dials
    for (var d=0; d<dials.length; d++){
      if(dials[d].prog>0){
        moved=true;
        //dbuga(d+" prog "+dials[d].prog);
        dials[d].prog-=dials[d].speed;
        if(dials[d].prog<=0){
          dials[d].prog=0;
          //dbug(pMod+" alarm is set to "+minuteOfDayToHour(pMod)+":"+minuteOfDayToMM(pMod)+" "+minuteOfDayToAmPm(pMod));
          }
        var prog=1-Math.abs(dials[d].prog)*dials[d].prog;
        dials[d].atVal=dials[d].initVal+prog*(dials[d].destVal-dials[d].initVal);
        }
      }
    }
  document.getElementById('alarmTimeHourDial').style.top=(.75-dials[0].atVal)*lineHeight+"px";
  document.getElementById('alarmTimeMinDial').style.top=(.75-dials[1].atVal)*lineHeight+"px";
  document.getElementById('alarmTimeAmPmDial').style.top=(.75-dials[2].atVal)*lineHeight+"px";
  //dbuga('touchingDial='+touchingDial);
  if(touchingDial==-1){
    //dbuga(pMod+" alarm is set to "+minuteOfDayToHour(pMod)+":"+minuteOfDayToMM(pMod)+" "+minuteOfDayToAmPm(pMod));
    }
  //dbuga('okay');
  }
var initHistory=[0,0,0,0,0,0,0,0];
function populateDials(){
  //dbuga("populateDials() 0");

  var mod=genericGet("alarmMinuteOfDay");
  dials=[];
  for (var d=0; d<pages[3].contents.length; d++){
    var pane=pages[3].contents[d];
    var dial={"name":pane.name+"Dial", "touchStart":0, "initVal":0, "atVal":0, "destVal":0, "maxVal":0, "speed":0, "prog":0, "history":initHistory, "max":0}; 
    dials.push(dial);
    }
  dials[0].initVal=(minuteOfDayToHour(mod)+11)%12;
  dials[1].initVal=minuteOfDayToMin(mod);
  //alert(mod+" "+minuteOfDayToMin(mod));
  dials[2].initVal=minuteOfDayToHalf(mod);
  //dials[3].initVal=genericGet("sleepMinutesDefault")/5-1;
  dials[0].atVal=dials[0].initVal;
  dials[1].atVal=dials[1].initVal;
  dials[2].atVal=dials[2].initVal;
  //dials[3].atVal=dials[3].initVal;
  dials[0].destVal=dials[0].initVal;
  dials[1].destVal=dials[1].initVal;
  dials[2].destVal=dials[2].initVal;
  //dials[3].destVal=dials[3].initVal;
  dials[0].maxVal=11;
  dials[1].maxVal=59;
  dials[2].maxVal=1;
  //dials[3].maxVal=12;

  var dialCode='<div id="alarmTimeHourDial" style="position:relative;">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12</div>';
  document.getElementById('page_alarm_content_alarmTimeHour').innerHTML=dialCode;
  var dialCode='<div id="alarmTimeMinDial" style="position:relative; text-align:center;">';
  for (var m=0; m<60; m++){
    if(m<10){dialCode+="0"+m+"<br />";}
    else{dialCode+=m+"<br />";}
    }

  dialCode+="</div>";
  document.getElementById('page_alarm_content_alarmTimeMin').innerHTML=dialCode;

  var dialCode='<div id="alarmTimeAmPmDial" style="position:relative; text-align:center;">AM<br />PM</div>';
  document.getElementById('page_alarm_content_alarmTimeAmPm').innerHTML=dialCode;

  var dialCode='<div id="sleepTimeDial" style="position:relative; text-align:center;">';
  for (var m=5; m<=60; m+=5){
    dialCode+=m+"<br />";
    }
  dialCode+="</div>";

  }
function selectPage(selectedPage){
  //dbuga("selectPage "+selectedPage);
  if(selectedPage=="extras"){
    getDownloads();
    }
  currentPage=selectedPage;
  for(var p=0; p<pageArray.length; p++){
    if(pageArray[p]==selectedPage){showPage(pageArray[p]);}
    else{
      hidePage(pageArray[p]);
      //dbuga('hidePage pageArray['+p+']='+pageArray[p]);
      }
    }
  }

function showPage(thePage){
  var pageStyle=document.getElementById('page_'+thePage).style;  
  pageStyle.display="block";
  window.setTimeout('currentOpacity1()', 10);
  }
function currentOpacity1(){
  document.getElementById('page_'+currentPage).style.opacity="1";
  }
var hideTimeout;

function hidePage(thePage){
  document.getElementById('page_'+thePage).style.opacity=hideByPage[thePage].opac;
  hideTimeout=setTimeout('hideTick()', 400);
  }

function hideTick(){
  for(var p=1; p<pageArray.length; p++){
    if(pageArray[p]!=currentPage){
      document.getElementById('page_'+pageArray[p]).style.display="none";  
      }
    }
  }

var ww=300;
var wh=400;
var leftOffset=0;
var topOffset=0;
var grid=32;
var navDelay=400;
var imagePath="images_small";
function populateContainer(){
  hideByPage={};
  buttonMap=[];
  pageArray=[];
  ww=window.innerWidth;
  wh=window.innerHeight;

  imagePath="images_large";//ipad retina
  if(ww<1536){imagePath="images_medium";}// ipad, iPhone retina can handle 768
  if(ww<640){imagePath="images_small";}//iphone, quarter scale is 384
  //dbuga(imagePath);
  var wAspect=ww/wh;
  leftOffset=0;
  topOffset=0;
  grid=32;
  var cw=320;
  var ch=480;
  //dbuga(" w:"+ww+" h:"+wh+" a:"+wAspect);
  if(wAspect<.75){//is taller than iPad so offset top
    leftOffset=0;
    cw=ww;
    ch=ww/.75;
    topOffset=(wh-ch)/2;
    grid=cw/48;
    }
  else{// iPad or fatter, offset left
    topOffset=0;
    ch=wh;
    cw=wh*.75;
    leftOffset=(ww-cw)/2;
    grid=cw/48;
    }
  document.getElementById('debugDiv').style.top=grid*0+"px";
  document.getElementById('wrapper').style.backgroundSize=grid*4+"px";
  document.getElementById('container').style.width=cw+"px";
  document.getElementById('container').style.height=ch+"px";
  document.getElementById('container').style.left=leftOffset+"px";
  document.getElementById('container').style.top=topOffset+"px";

  var htmlString="";

  for(var p=0; p<pages.length; p++){

    page=pages[p];
    //dbuga("populateContainer() "+page.name);

    heightsByPage[page.name]=grid*page.height;
    hideStyle='top:'+(grid*page.hideTop+page.hideTopMargin*topOffset)+'px; left:'+(grid*page.hideLeft+page.hideLeftMargin*leftOffset)+'px; opacity:'+page.hideOpac+';';
    htmlString+='<div id="page_'+page.name+'" class="pages" style="background-image:url('+imagePath+'/bg_'+page.name+'.jpg); width:'+ grid*48 +'px; height:'+ grid*page.height +'px; '+hideStyle+'">';
    pageArray.push(page.name);
    hideByPage[page.name]={"top":(grid*page.hideTop+page.hideTopMargin*topOffset), "left":(grid*page.hideLeft+page.hideLeftMargin*leftOffset), "opac":page.hideOpac};
    buttons=page.buttons;
    for(var b=0; b<buttons.length; b++){
      button=buttons[b];
      if((button.name=="phone")&&(topOffset==0)){
        htmlString+='<div id="page_'+page.name+'_button_'+button.name+'" style="font-size:'+3.3*grid+'px; line-height:'+5.5*grid+'px; text-align:center; width:'+ grid*button.width +'px; height:'+ grid*button.height +'px; left:'+ grid*button.left +'px; top:'+ grid*button.top +'px;">';
        htmlString+='<a href="tel:+16126264770"><img src="'+imagePath+'/page_'+page.name+'_button_'+button.name+'_off.png" style="border:0;" width="'+grid*button.width+'" height="'+grid*button.height+'" /></a>';
        htmlString+='</div>'
        }
      else{
        buttonMap.push({"page":page.name, "name":button.name, "left":grid*button.left, "right":grid*button.left+grid*button.width, "top":grid*button.top, "bottom":grid*button.top+grid*button.height});
        htmlString+='<div id="page_'+page.name+'_button_'+button.name+'" class="buttons" style="background-image:url('+imagePath+'/page_'+page.name+'_button_'+button.name+'_off.png?1); width:'+ grid*button.width +'px; height:'+ grid*button.height +'px; left:'+ grid*button.left +'px; top:'+ grid*button.top +'px;">';
        htmlString+='<div id="page_'+page.name+'_button_'+button.name+'_on" class="buttons" style="opacity:0; background-image:url('+imagePath+'/page_'+page.name+'_button_'+button.name+'_on.png?1); width:'+ grid*button.width +'px; height:'+ grid*button.height +'px; left:0px; top:0px;">';
        htmlString+='</div>'
        htmlString+='</div>'
        }
      }
    contents=page.contents;
    for(var c=0; c<contents.length; c++){
      content=contents[c];
      htmlString+='<div id="page_'+page.name+'_content_'+content.name+'" style="overflow:hidden; ';
      htmlString+='width:'+ grid*content.width +'px; height:'+ grid*content.height +'px;  line-height:'+ Math.floor(grid*content.lineHeight) +'px;  ';
      htmlString+='font-size:'+ grid*content.fontSize +'px; text-align:'+content.textAlign+'; ';
      htmlString+='color:'+content.color +'; left:'+grid*content.left+'px;  ';
      htmlString+='font-family:'+ content.fontFamily +'; top:'+ grid*content.top +'px;">';
      htmlString+=content.defaultText;
      htmlString+='</div>'
      }
    htmlString+='</div>'
    }
  document.getElementById('container').innerHTML=htmlString;
  clearInterval(secondInterval);
  clearInterval(dimensionInterval);
  dimensionInterval=setInterval('dimensionTick()', 1000);
  secondInterval=setInterval('secondTick()', 1000);
  populateDials();
  selectCurrentPage();
  //dbuga('add iScrolls');
  /*
  resultsHolderScroll=new iScroll('resultsHolder');
  playlistHolderScroll=new iScroll('playlistHolder');
  calendarHolderScroll=new iScroll('calendarHolder');
  cqHolderScroll=new iScroll('cqHolder');
  totdHolderScroll=new iScroll('totdHolder');
  wrsHolderScroll=new iScroll('wrsHolder');
  */
  var scrollIdArray=["resultsHolder", "playlistHolder", "calendarHolder", "cqHolder", "totdHolder", "wrsHolder"];
  for (var s=0; s<scrollIdArray.length; s++){
    new ScrollFix(document.getElementById(scrollIdArray[s]));
    }
  dbuga('populate ran ok');
  }
function populateFaqs(){
  var htmlString="";
  var answersString="";
  for (var f=0; f<faqs.length; f++){
    var q=faqs[f].q;
    var a=faqs[f].a;

    var quoteParts=a.split('"');
    for(var p=0; p<quoteParts.length; p++){
      var thisPart= quoteParts[p];
      if(thisPart.indexOf('http')>-1){
        quoteParts[p]='javascript:remoteLink(\''+thisPart+'\');'+returnFalse;
        }
      }
    a=quoteParts.join('"');
    //'<a href="javascript:remoteLink(\''+result.collectionViewUrl+'\');'+returnFalse+'">';

    var grad="background-image: -webkit-gradient(linear,left top,left bottom, color-stop(0%, #232323), color-stop(2%, #232323), color-stop(3%, #181818), color-stop(100%, #000));";

    a=a.replace(/socialSize/g, (7*grid)+"px");
    htmlString+='<div id="question_'+f+'" class="questionHolder" style="width:'+48*grid+'px; max-height:'+10*grid+'px; '+grad+'">';
    htmlString+=  '<div id="twistie_'+f+'" class="twistie" style="padding-top:'+1.1*grid+'px; padding-bottom:'+1.1*grid+'px; width:'+40*grid+'px; ';
    htmlString+=  'padding-left:'+grid*3+'px; padding-right:'+grid*6+'px; line-height:'+2.4*grid+'px; font-size:'+1.9*grid+'px; ';
    htmlString+=  'background-image:url('+imagePath+'/page_faqs_button_twistie_on.png); background-size:'+7*grid+'px '+7*grid+'px;">'+q+'</div>'; 
    htmlString+='</div>'
    answersString+='<div id="answer_'+f+'" class="answer"  style="width:'+40*grid+'px; margin-left:'+grid*3+'px; top:'+grid*10+'px; line-height:'+2.6*grid+'px; font-size:'+2*grid+'px;">'+a+'</div>';
    }
  document.getElementById('page_faqs_content_faqsDiv').innerHTML=htmlString+answersString;
  


  var htmlString="";
  htmlString+='<div class="questionHolder" style="width:'+48*grid+'px;'+grad+'">';
  htmlString+=  '<div style="color:#aaa; padding-top:'+.75*grid+'px; font-family:akziregular; ';
  htmlString+=  'padding-bottom:'+1*grid+'px; width:'+44*grid+'px; ';
  htmlString+=  'padding-left:'+grid*3+'px; padding-right:'+grid*2+'px; ';
  htmlString+=  'line-height:'+1.8*grid+'px; font-size:'+1.6*grid+'px;">';
  htmlString+=  '&copy; Regents of the University of Minnesota 2013.<br>All rights reserved. Developed by <a href="http://jambots.com">Jambots.com</a>'; 
  htmlString+='</div>'
  document.getElementById('page_faqs_content_regentsDiv').innerHTML=htmlString;
  }

function selectTwistie(theTwistie){
  //dbuga('selectTwistie('+theTwistie+')');
  selectedTwistie=theTwistie;
  if(theTwistie==-1){
    //reveal all questions, hide all answers
    for (q=0; q<faqs.length; q++){
      var thisQuestion=document.getElementById('question_'+q)
      var thisTwistie=document.getElementById('twistie_'+q)
      var thisAnswer=document.getElementById('answer_'+q)
      thisQuestion.style.maxHeight=10*grid+'px'; 
      thisQuestion.style.height='auto'; 
      thisTwistie.style.backgroundImage='url('+imagePath+'/page_faqs_button_twistie_on.png)';
      thisAnswer.style.display="none";
      }
    }
  else{
    for (q=0; q<faqs.length; q++){
      var thisQuestion=document.getElementById('question_'+q)
      var thisTwistie=document.getElementById('twistie_'+q)
      var thisAnswer=document.getElementById('answer_'+q)
      if(q==theTwistie){
        //reveal selected question and answer
        thisQuestion.style.maxHeight=10*grid+'px'; 
        thisQuestion.style.height='auto'; 
        //thisTwistie.style.maxHeight=10*grid+'px'; 
        thisTwistie.style.backgroundImage='url('+imagePath+'/page_faqs_button_twistie_off.png)';
        thisAnswer.style.display="block";
        }
      else{
        // hide all other q&a 
        thisQuestion.style.height=0*grid+'px'; 
        //thisTwistie.style.maxHeight=0*grid+'px'; 
        thisTwistie.style.backgroundImage='url('+imagePath+'/page_faqs_button_twistie_on.png)';
      thisAnswer.style.display="none";
        }
      }
    }
  }
var selectedTwistie=-1;

var hideByPage={};
var buttonMap=[];
var pageArray=[];
var heightsByPage={};
var pages=[
{"name":"footnav", "hideLeft":0, "hideTop":0,  "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":1, "height":64,
   "buttons":[
    {"name":"listen", "top":58, "left":0, "height":6, "width":16},
    {"name":"request", "top":58, "left":16, "height":6, "width":16},
    {"name":"donate", "top":58, "left":32, "height":6, "width":16}
  ],
  "contents":[
  ]
},
{"name":"listen", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":1, "height":58,
  "buttons":[
    {"name":"more", "top":0, "left":0, "height":7, "width":16},
    {"name":"playlist", "top":0, "left":32, "height":7, "width":16},
    {"name":"playpause", "top":38, "left":12, "height":12, "width":24}
  ],
  "contents":[
    {"name":"nowPlayingDiv", "top":29.5, "left":1, "width":46, "height":8, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":""},
    {"name":"djDiv", "top":51, "left":1, "width":46, "height":8, "lineHeight":2.5, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":""}
  ]
},
{"name":"more", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"extras", "top":11, "left":9, "height":6, "width":30},
    {"name":"events", "top":18, "left":9, "height":6, "width":30},
    {"name":"alarm", "top":25, "left":9, "height":6, "width":30},
    {"name":"settings", "top":32, "left":9, "height":6, "width":30},
    {"name":"faqs", "top":39, "left":9, "height":6, "width":30}
  ],
  "contents":[
  ]
},
{"name":"alarm", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"cancel", "top":0, "left":36, "height":7, "width":12},
    {"name":"timeset", "top":21, "left":9, "height":12, "width":30},
    {"name":"set", "top":35, "left":9, "height":6, "width":30},
  ],
  "contents":[
    {"name":"alarmTimeHour", "top":22, "left":15, "width":6, "height":10, "lineHeight":4, "fontSize":4, "fontFamily":"akzibold", "color":"black", "textAlign":"right", "defaultText":"hh"},
    {"name":"alarmTimeMin", "top":22, "left":21, "width":6, "height":10, "lineHeight":4, "fontSize":4, "fontFamily":"akzibold", "color":"black", "textAlign":"left", "defaultText":"mm"},
    {"name":"alarmTimeAmPm", "top":22, "left":27, "width":8, "height":10, "lineHeight":4, "fontSize":4, "fontFamily":"akzibold", "color":"black", "textAlign":"center", "defaultText":"ampm"},
  ]
},
{"name":"armed", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":64,
  "buttons":[
    {"name":"cancelalarm", "top":17, "left":9, "height":6, "width":30},
  ],
  "contents":[
    {"name":"nowtime", "top":30, "left":8, "width":32, "height":14, "lineHeight":8, "fontSize":8, "fontFamily":"akzilight", "color":"#fff", "textAlign":"center", "defaultText":"00:00:00"},
    {"name":"nowAmPm", "top":34, "left":39, "width":8, "height":7, "lineHeight":4, "fontSize":2.9, "fontFamily":"akzilight", "color":"#fff", "textAlign":"center", "defaultText":"AM"},
    {"name":"alarmtext", "top":47, "left":1, "width":46, "height":12, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzilight", "color":"white", "textAlign":"center", "defaultText":"alarmtext"}
  ]
},
{"name":"wakeup", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":64,
  "buttons":[
    {"name":"alarmoff", "top":17, "left":9, "height":6, "width":30},
    {"name":"snooze", "top":47, "left":9, "height":6, "width":30},
  ],
  "contents":[
    {"name":"nowtime", "top":30, "left":8, "width":32, "height":14, "lineHeight":8, "fontSize":8, "fontFamily":"akzilight", "color":"#fff", "textAlign":"center", "defaultText":"00:00:00"},
    {"name":"nowAmPm", "top":34, "left":39, "width":8, "height":7, "lineHeight":4, "fontSize":2.9, "fontFamily":"akzilight", "color":"#fff", "textAlign":"center", "defaultText":"AM"}
  ]
},
{"name":"shop", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
  ],
  "contents":[
    {"name":"results", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="resultsHolder"><div id="resultsScroller"></div></div>'}
  ]
},
{"name":"settings", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"medium", "top":14, "left":9, "height":6, "width":30},
    {"name":"higher", "top":21, "left":9, "height":6, "width":30}
  ],
  "contents":[
  ]
},
{"name":"request", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"phone", "top":11, "left":9, "height":6, "width":30},
    {"name":"email", "top":18, "left":9, "height":6, "width":30},
    {"name":"tweet", "top":25, "left":9, "height":6, "width":30}
  ],
  "contents":[
  ]
},
{"name":"playlist", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"refresh", "top":0, "left":36, "height":7, "width":12},
  ],
  "contents":[
    {"name":"playlist", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="playlistHolder"><div id="playlistScroller"></div></div>'}
  ]
},
{"name":"events", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
  ],
  "contents":[
    {"name":"events", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="calendarHolder"><div id="calendarScroller"></div></div>'}
  ]
},
{"name":"extras", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"cq", "top":9, "left":2, "height":11, "width":11},
    {"name":"totd", "top":21, "left":2, "height":11, "width":11},
    {"name":"wrs", "top":33, "left":2, "height":11, "width":11},
    {"name":"vc", "top":45, "left":2, "height":11, "width":11},
  ],
  "contents":[
    {"name":"cqDesc", "top":9, "left":15, "width":32, "height":12, "lineHeight":2, "fontSize":1.5, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":"<a href=\"javascript:handleButton('extras','cq');\">CULTURE QUEUE</a><br />Radio K's award-winning Arts and Culture program, dedicated to telling stories about the many wonders of the Twin Cities that you won't hear anywhere else."},
    {"name":"totdDesc", "top":21, "left":15, "width":32, "height":12, "lineHeight":2, "fontSize":1.5, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":"<a href=\"javascript:handleButton('extras','totd');\">TRACK OF THE DAY</a><br />Every day Radio K offers up a fresh new track for you to download. It's just one more way that Real College Radio makes Real Life (a little more) Rockin'."},
    {"name":"wrsDesc", "top":33, "left":15, "width":32, "height":12, "lineHeight":2, "fontSize":1.5, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":"<a href=\"javascript:handleButton('extras','wrs');\">WEEKLY RELEASE SPOTLIGHT</a><br />Each week we comb through mountains of new music to find that one perfect album that we (and you) almost missed."},
    {"name":"vcDesc", "top":45, "left":15, "width":32, "height":12, "lineHeight":2, "fontSize":1.5, "fontFamily":"akzibold", "color":"white", "textAlign":"center", "defaultText":"<a href=\"javascript:handleButton('extras','vc');\">VINYL CLOSET</a><br />A digitized archive of Studio K performances from 1994 to 2006 that feature seminal Minnesota artists that have left an indelible mark on the Minnesota music scene."},
  ]
},
{"name":"totd", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"stotd", "top":0, "left":0, "height":7, "width":12},
  ],
  "contents":[
    {"name":"downloads", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="totdHolder"><div id="totdScroller"></div></div>'}
  ]
},
{"name":"wrs", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
  ],
  "contents":[
    {"name":"downloads", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="wrsHolder"><div id="wrsScroller"></div></div>'}
  ]
},
{"name":"cq", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0,  "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9},
    {"name":"scq", "top":0, "left":0, "height":7, "width":12},
  ],
  "contents":[
    {"name":"downloads", "top":7, "left":0, "height":51, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":'<div id="cqHolder"><div id="cqScroller"></div></div>'}
  ]
},
{"name":"faqs", "hideLeft":0, "hideTop":0, "hideLeftMargin":0, "hideTopMargin":0, "hideOpac":0, "height":58,
  "buttons":[
    {"name":"done", "top":0, "left":39, "height":7, "width":9}
  ],
  "contents":[
    {"name":"faqsDiv", "top":7.5, "left":0, "height":45.5, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":"How do I become a rich and<br>famous Radio K DJ?"},
    {"name":"regentsDiv", "top":53, "left":0, "height":5, "width":48, "lineHeight":2.6, "fontSize":2, "fontFamily":"akzibold", "color":"white", "textAlign":"left", "defaultText":"How do I become a rich and<br>famous Radio K DJ?"}
  ]
}];
// test broken button
//    {"name":"broken", "top":28, "left":9, "height":6, "width":30}

function dbuga(theString){
  if(debugging){
    document.getElementById('debugDiv').style.display="block";
    document.getElementById('debugDiv').innerHTML+="<br />"+theString;
    }
  }

function dbug(theString){
  if(debugging){
    document.getElementById('debugDiv').style.display="block";
    document.getElementById('debugDiv').innerHTML=theString;
    }
  }
function rnd(theSeed){
  //return 0;
  return Math.floor(Math.random()*theSeed);
  }
function range(theRange){
  //return 0;
  return rnd(theRange)-theRange/2;
  }

function gestureStart(event) {
  //event.preventDefault(); 
  }
function gestureChange(event) {
  //event.preventDefault(); 
  }
function gestureEnd(event) {
  //event.preventDefault(); 
  }

function touchCancel(event){
  event.preventDefault(); 
  }
var debugCount=0;
function touchStart(event){
  if(event.touches.length>3){
    debugCount++;
    if(debugCount>3){
      debugging=true;
      }
    }
  mouseX=event.touches[0].pageX;
  mouseY=event.touches[0].pageY;
  //event.preventDefault(); 
  handleTouchEvent(event);
  }
function mousedown(e){
  //dbug('mousedown(e) touchingDial='+touchingDial);
  mouseX=e.pageX;
  mouseY=e.pageY;
  //dbug('moused '+ e.target.id);
  handleTouchEvent({"type":"touchstart", "touches":[{"pageX":e.clientX, "pageY":e.clientY, "target":e.target}]});
  }

function mousemove(e){
  mouseX=e.pageX;
  mouseY=e.pageY;
  }
function touchMove(event){
  if((currentPage !="totd")&&(currentPage !="wrs")&&(currentPage !="cq")&&(currentPage !="playlist")&&(currentPage !="events")&&(currentPage !="shop")){
    event.preventDefault();
    }
  if(currentPage =="alarm"){
    mouseX=event.touches[0].pageX;
    mouseY=event.touches[0].pageY; 
    }
  if(lastTouchId.indexOf("page_")>-1){
    event.preventDefault();
    }
  //dbuga('end of tm'); 
 }

function touchEnd(event){
  //dbuga('touchEnd(event) touchingDial='+touchingDial);
  //event.preventDefault();
  if(touchingDial==-1){
    handleTouchEvent(event);
    }
  else{
    endDialTouch();
    }
  }
function moused(e){
  //dbuga('moused '+ e.target.id);
  //if(e.target.id=="stateDiv"){dbug('');}
  //handleTouchEvent({"type":"touchstart", "touches":[{"pageX":e.clientX, "pageY":e.clientY, "target":e.target}]});
  }

var touchingDial=-1;
var touching=false;
var touchTimeout
function mouseup(e){
  //dbuga('mouseup(e) touchingDial='+touchingDial);
  endDialTouch();
  }
function endDialTouch(){
  //dbuga(' -- endDialTouch() touchingDial='+touchingDial);
  if(touchingDial>-1){

    //set up inertial docking
    dials[touchingDial].initVal=dials[touchingDial].atVal;
    dials[touchingDial].speed=1/20;
    var totalDelta=0;
    //dbuga(' -- 1 endDialTouch() touchingDial='+touchingDial);
    for (var h=0; h<dials[touchingDial].history.length; h++){
      totalDelta+=dials[touchingDial].history[h];
      }
    var toss=0-totalDelta/(grid*4);
    //alert(toss);
    //dbuga(' -- endDialTouch() touchingDial='+touchingDial);
    dials[touchingDial].destVal=Math.floor(dials[touchingDial].initVal+toss+.5);
    dials[touchingDial].prog=1;
    if(dials[touchingDial].destVal<0){dials[touchingDial].destVal=0;}
    if(dials[touchingDial].destVal>dials[touchingDial].maxVal){dials[touchingDial].destVal=dials[touchingDial].maxVal;}
    var hour=(dials[0].destVal+1)%12;
    //dbuga(' --  hour='+hour);
    //dbuga(' -- dials[0].destVal='+dials[0].destVal);
    //dbuga(' -- dials[1].destVal='+dials[1].destVal);
    //dbuga(' -- dials[2].destVal='+dials[2].destVal);
    genericSet("alarmMinuteOfDay", 60*hour+dials[1].destVal+dials[2].destVal*60*12);
    //dbuga("amod 7 :"+genericGet("alarmMinuteOfDay"));
    touchingDial=-1;
    //dbuga(' -- 8 endDialTouch() touchingDial='+touchingDial);
    }
  }

function buttonOn(thePage, theButton){
  document.getElementById('page_'+thePage+'_button_'+theButton+'_on').style.opacity="1";
  }
function buttonOff(thePage, theButton){
  document.getElementById('page_'+thePage+'_button_'+theButton+'_on').style.opacity="0";
  }

// original 2016 streams
var urlByQuality={
  "low":"http://radiokstreams.cce.umn.edu:8056/;", 
  "medium":"http://radiokstreams.cce.umn.edu:8128/;", 
  "high":"http://radiokstreams.cce.umn.edu:8256/;", 
  "higher":"http://radiokstreams.cce.umn.edu:8256/;", 
  "broken":"http://radiokstreams.cce.umn.edu:8168/;"
};
/*
var urlByQuality={
  "low":"http://radiokstreams.cce.umn.edu:8056/;", 
  "medium":"http://radiokstreams.cce.umn.edu:8128/;", 
  "high":"http://radiokstreams.cce.umn.edu:8256/;", 
  "higher":"http://radiokstreams.cce.umn.edu:8256/;", 
  "broken":"http://radiokstreams.cce.umn.edu:8168/;"
};
var urlByQuality={
  "low":"http://wtbu.bu.edu:1800/listen.m3u", 
  "medium":"http://wtbu.bu.edu:1800/listen.m3u", 
  "high":"http://wtbu.bu.edu:1800/listen.m3u", 
  "higher":"http://wtbu.bu.edu:1800/listen.m3u", 
  "broken":"http://wtbu.bu.edu:1800/listen.m3u"
};
*/
//http://wtbu.bu.edu:1800/listen.m3u



function shop(artist, album, song){
  //dbuga("shop("+artist+", "+album+", "+song+")");
  selectPage("shop");
  var artistAlbumSong=artist+" "+album+" "+song;
  var terms=artistAlbumSong.replace(/ /g, "+");
  document.getElementById('resultsScroller').innerHTML="searching: "+artist+"<br>"+album;
  var feedUrl="https://itunes.apple.com/search?limit=20&term="+terms;
  $.ajax({
    url: feedUrl,
    dataType: "text",        //  new bit
    success: function(data) {parseItunesResults(data);}
    });
  }
// remove errors on publish
function parseItunesResults(theData){
  //dbuga("parseItunesResults");
  var itunesJson=JSON.parse(theData);
  var allResults=itunesJson.results;
  var glom="|";
  var results=[];
  for(var r=0; r<allResults.length; r++){
    var result=allResults[r];
    var testString="|"+result.artistName+result.collectionName+"|";
    if(glom.indexOf(testString)==-1){
      glom+=testString;
      results.push(result);
      }
    }

  var gradStyle=returnGradStyle();

  //var gradStyle="background-image: -webkit-gradient(linear,left top,left bottom, color-stop(0%, #F2F2F2), color-stop(2%, #F2F2F2), color-stop(3%, #EDEDED), color-stop(50%, #fff), color-stop(100%, #fff));";
  var headStyle='clear:both; padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*4 +'px;  line-height:'+ grid*2.5 +'px; text-align:center;';
  var textStyle='clear:both; padding-top:'+grid*1.8+'px; width:'+ grid*48 +'px; min-height:'+ grid*16 +'px;  line-height:'+ grid*2.5 +'px; text-align:left;';
  var imgStyle='float:left; padding-top:'+grid*1.8+'px; width:'+ grid*12 +'px; height:'+ grid*12 +'px; margin:0 '+ grid*2 +'px 0 '+ grid*2 +'px;'
  var htmlBlock="";
  //dbuga("results.length="+results.length);
  if(results.length>0){
    htmlBlock='<div class="playlistItem" style="'+headStyle+' '+gradStyle+' ">';
    htmlBlock+=  'iTunes Results';
    htmlBlock+='</div>';
    for(var r=0; r<results.length; r++){
      var result=results[r];
      //dbuga(result.artistName+" "+result.collectionName);
      htmlBlock+='<div class="playlistItem" style="'+textStyle+' '+gradStyle+'">';
      htmlBlock+=  '<a href="javascript:remoteLink(\''+result.collectionViewUrl+'\');'+returnFalse+'"><img src="'+result.artworkUrl100+'" style="'+imgStyle+'" /></a>';
      htmlBlock+=  '<br /><span style="font-family:akziregular;">'+result.artistName+'</span>';
      htmlBlock+=  '<br /><a href="javascript:remoteLink(\''+result.collectionViewUrl+'\');'+returnFalse+'"><span style="">'+result.collectionName+'</span></a>';
      htmlBlock+='</div>';
      }
    }
  else{
    htmlBlock="Sorry, no items found.";
    }
  document.getElementById('resultsScroller').innerHTML=htmlBlock;
  document.getElementById('resultsHolder').style.width=grid*48+'px'; 
  document.getElementById('resultsHolder').style.height=grid*51+'px'; 
  //resultsScrollerTimeout=window.setTimeout("refreshResultsHolderScroll()", 100);
  }
/*
var resultsScrollerTimeout;
function refreshResultsHolderScroll(){
  resultsHolderScroll.refresh();
  }
*/
var resultsHolderScroll;
var calendarHolderScroll;
var playlistHolderScroll;
function alarmStatusChanged(alarmIsSet){
  //dbuga("app says alarmStatusChanged("+alarmIsSet+")");
  }
var mouseX=0;
var mouseY=0;
var mouseStartX=0;
var mouseStartY=0;
var alarmFailsafeTimeout;
function remoteLink(theUrl){
  if(theUrl.indexOf('mp3')>-1){
    uiPlaying=false;
    retrying=false;
    buttonOff("listen", "playpause");
    if(streamPlaying){stopStream();}
    }
  if(android){
    var ref = window.open(theUrl, "_system");
    }
  if(ios){
    var ref = window.open(theUrl, "_system");
    }


/*
  //window.plugins.childBrowser.openExternal(theUrl);

  if(android){
    window.plugins.ChildBrowser.openExternal(theUrl, false);
    }
  if(ios){
    window.plugins.ChildBrowser.showWebPage(theUrl, { showLocationBar: true });
    }
  //navigator.app.loadUrl(theUrl, {openExternal: true});
*/

  //dbuga("remoteLink ran");
  }

function remoteCqLink(cqNum){
    uiPlaying=false;
    retrying=false;
    buttonOff("listen", "playpause");
    
 var downloadItem=cqDownloads[Number(cqNum)];
  var theUrl=downloadItem.link;
  //dbuga("remoteLink("+theUrl+")");
  //window.plugins.childBrowser.openExternal(theUrl);
  navigator.app.loadUrl(theUrl, {openExternal: true});
  //dbuga("remoteLink ran");
  }

function handleButton(pageName, buttonName){
  //dbug("handleButton("+pageName+", "+buttonName+")");
  if(pageName=="alarm"){
    if(buttonName=="timeset"){
      mouseStartX=mouseX;
      mouseStartY=mouseY;
      var buttLeft=pages[3].buttons[1].left*grid+leftOffset;
      var buttWidth=pages[3].buttons[1].width*grid;
      deltaX=mouseX-buttLeft;
      var xFrac=deltaX/buttWidth;
      touchingDial=1;
      if(xFrac<.45){touchingDial=0;}
      if(xFrac>.65){touchingDial=2;}
      //alert("mouseX="+ mouseX+" buttLeft="+ buttLeft+ " deltax:"+deltaX+" / buttWidth:"+buttWidth+" = xFrac:"+xFrac);

      var mod=genericGet("alarmMinuteOfDay");
      if(touchingDial!=0){
        dials[0].initVal=(minuteOfDayToHour(mod)+11)%12;
        }
      else{
        dials[0].initVal=dials[0].atVal;
        }

      if(touchingDial!=1){
        dials[1].initVal=minuteOfDayToMin(mod);
        }
      else{
        dials[1].initVal=dials[1].atVal;
        }
      if(touchingDial!=2){
        dials[2].initVal=minuteOfDayToHalf(mod);
        }
      else{
        dials[2].initVal=dials[2].atVal;
        }
      dials[0].atVal=dials[0].initVal;
      dials[1].atVal=dials[1].initVal;
      dials[2].atVal=dials[2].initVal;
      dials[0].destVal=dials[0].initVal;
      dials[1].destVal=dials[1].initVal;
      dials[2].destVal=dials[2].initVal;

      dials[0].history=initHistory;
      dials[1].history=initHistory;
      dials[2].history=initHistory;
        
      }
    if(buttonName=="sleepset"){
      mouseStartX=mouseX;
      mouseStartY=mouseY;
      touchingDial=3;

      dials[3].initVal=dials[3].atVal;
      dials[3].atVal=dials[3].initVal;
      dials[3].destVal=dials[3].initVal;
      dials[3].history=initHistory;
      }

    if(buttonName=="set"){
      if(streamPlaying){stopStream();}
      sleepSeconds=0;
      var mil=""+minuteOfDayToHH(genericGet("alarmMinuteOfDay"))+minuteOfDayToMM(genericGet("alarmMinuteOfDay"));
      buttonOn("alarm", "set");
      var textTime=minuteOfDayToHour(genericGet("alarmMinuteOfDay"))+":"+minuteOfDayToMM(genericGet("alarmMinuteOfDay"))+" "+minuteOfDayToAmPm(genericGet("alarmMinuteOfDay"));
      document.getElementById("page_armed_content_alarmtext").innerHTML="Alarm is set for <br />"+textTime+"<br />(do not close)";
      window.setTimeout('buttonOff("alarm", "set"); selectPage("armed");', navDelay);
      snoozeMinutes=0;
      alarming=false;
      uiPlaying=false;
      buttonOff("listen", "playpause");
      //dbuga("in set singMedia.play() singing=false");
      singing=false;
      singMedia.play();
      //dbuga("--passed");
      }
    if(buttonName=="cancel"){
      buttonOn("alarm", "cancel");
      window.setTimeout('buttonOff("alarm", "cancel"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    //dbuga('handleButton('+pageName+', '+buttonName+')');
    }
  if(pageName=="wakeup"){
    if(buttonName=="alarmoff"){

      uiPlaying=false;
      buttonOff("listen", "playpause");
      alarming=false;
      stopStream();
      singMedia.stop();
      //dbuga('alarmoff so singing=false');
      singing=false;
      buttonOn("wakeup", "alarmoff");
      window.setTimeout('buttonOff("wakeup", "alarmoff"); selectPage("listen");', navDelay);
      }
    if(buttonName=="snooze"){
      var nowDate=new Date();
      var nowMod=nowDate.getHours()*60+nowDate.getMinutes();
      snoozeMinutes=nowMod-genericGet("alarmMinuteOfDay")+7;
      var textTime=minuteOfDayToHour(genericGet("alarmMinuteOfDay")+snoozeMinutes)+":"+minuteOfDayToMM(genericGet("alarmMinuteOfDay")+snoozeMinutes)+" "+minuteOfDayToAmPm(genericGet("alarmMinuteOfDay")+snoozeMinutes);
      document.getElementById("page_armed_content_alarmtext").innerHTML="Alarm is set for <br />"+textTime+"<br />(do not close)";
      uiPlaying=false;
      buttonOff("listen", "playpause");
      singMedia.stop();
      singing=false;
      //dbuga('snooze so singing=false'); 

      alarming=false;
      stopStream();
      buttonOn("wakeup", "snooze");
      window.setTimeout('buttonOff("wakeup", "snooze"); selectPage("armed");', navDelay);
      }
    }
  if(pageName=="armed"){
    if(buttonName=="cancelalarm"){
      buttonOn("armed", "cancelalarm");
      window.setTimeout('buttonOff("armed", "cancelalarm"); selectPage("alarm");', navDelay);
      }
    }
  if(pageName=="footnav"){
    if(buttonName=="listen"){
      selectPage("listen");
      buttonOn("footnav", "listen");
      buttonOff("footnav", "request");
      }
    if(buttonName=="request"){
      selectPage("request");
      buttonOff("footnav", "listen");
      buttonOn("footnav", "request");
      }
    if(buttonName=="donate"){
      buttonOn("footnav", "donate");
      window.setTimeout('buttonOff("footnav", "donate")', navDelay*2);
      //window.location.href="http://www.radiok.org/donate/";
      window.setTimeout("remoteLink('http://www.radiok.org/donate/')", navDelay);
      }
    }
  if(pageName=="listen"){
    if(buttonName=="settings"){
      buttonOff("footnav", "listen");
      buttonOn("listen", "settings");
      window.setTimeout('buttonOff("listen", "settings"); selectPage("settings");', navDelay);
      }
    if(buttonName=="more"){
      buttonOff("footnav", "listen");
      buttonOn("listen", "more");
      window.setTimeout('buttonOff("listen", "more"); selectPage("more");', navDelay);
      }
    if(buttonName=="playlist"){
      buttonOff("footnav", "listen");
      buttonOn("listen", "playlist");
      window.setTimeout('buttonOff("listen", "playlist"); selectPage("playlist");', navDelay);
      getRecentSongs();
      }
    if(buttonName=="playpause"){
      togglePlaying();
      }
    }
  if(pageName=="more"){
    if(buttonName=="done"){
      buttonOn("more", "done");
      window.setTimeout('buttonOff("more", "done"); selectPage("listen");', navDelay);
      }
    if(buttonName=="settings"){
      buttonOff("footnav", "listen");
      buttonOn("more", "settings");
      window.setTimeout('buttonOff("more", "settings"); selectPage("settings");', navDelay);
      }
    if(buttonName=="extras"){
      buttonOff("footnav", "listen");
      buttonOn("more", "extras");
      window.setTimeout('buttonOff("more", "extras"); selectPage("extras");', navDelay);
      }
    if(buttonName=="alarm"){
      buttonOff("footnav", "listen");
      buttonOn("more", "alarm");
      window.setTimeout('buttonOff("more", "alarm"); selectPage("alarm");', navDelay);
      }
    if(buttonName=="faqs"){
      buttonOff("footnav", "listen");
      buttonOn("more", "faqs");
      window.setTimeout('buttonOff("more", "faqs"); selectPage("faqs");', navDelay);
      }
    if(buttonName=="events"){
      buttonOff("footnav", "listen");
      buttonOn("more", "events");
      window.setTimeout('buttonOff("more", "events"); selectPage("events");', navDelay);
      getCalendar();
      }
    if(buttonName=="playlist"){
      buttonOff("footnav", "listen");
      buttonOn("more", "playlist");
      window.setTimeout('buttonOff("more", "playlist"); selectPage("playlist");', navDelay);
      getRecentSongs();
      }
    }

  if(pageName=="shop"){
    if(buttonName=="done"){
      buttonOn("shop", "done");
      window.setTimeout('buttonOff("shop", "done"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    }
  if(pageName=="extras"){
    if(buttonName=="done"){
      buttonOn("extras", "done");
      window.setTimeout('buttonOff("extras", "done"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    if(buttonName=="totd"){
      buttonOn("extras", "totd");
      window.setTimeout('buttonOff("extras", "totd"); selectPage("totd");', navDelay);
      }
    if(buttonName=="wrs"){
      buttonOn("extras", "wrs");
      window.setTimeout('buttonOff("extras", "wrs"); selectPage("wrs");', navDelay);
      }
    if(buttonName=="cq"){
      buttonOn("extras", "cq");
      window.setTimeout('buttonOff("extras", "cq"); selectPage("cq");', navDelay);
      }
    if(buttonName=="vc"){
      window.setTimeout("remoteLink('http://www.radiok.org/vinylcloset/')", navDelay);
      }
    }
  if(pageName=="totd"){
    if(buttonName=="done"){
      buttonOn("totd", "done");
      window.setTimeout('buttonOff("totd", "done"); selectPage("extras");', navDelay);
      }
    if(buttonName=="stotd"){
      buttonOn("totd", "stotd");
      window.setTimeout('buttonOff("totd", "stotd"); remoteLink("https://itunes.apple.com/us/podcast/radio-ks-track-of-the-day/id389816740?mt=2");', navDelay);
      }
    }
  if(pageName=="wrs"){
    if(buttonName=="done"){
      buttonOn("wrs", "done");
      window.setTimeout('buttonOff("wrs", "done"); selectPage("extras");', navDelay);
      }
    }
  if(pageName=="cq"){
    if(buttonName=="done"){
      buttonOn("cq", "done");
      window.setTimeout('buttonOff("cq", "done"); selectPage("extras");', navDelay);
      }
    if(buttonName=="scq"){
      buttonOn("cq", "scq");
      window.setTimeout('buttonOff("cq", "scq"); remoteLink("https://itunes.apple.com/us/podcast/culture-queue/id862798048?mt=2");', navDelay);
      }
    }
  if(pageName=="settings"){
    if(buttonName=="faqs"){
      buttonOn("settings", "faqs");
      window.setTimeout('buttonOff("settings", "faqs"); selectPage("faqs");', navDelay);
      }
    if(buttonName=="done"){
      buttonOn("settings", "done");
      window.setTimeout('buttonOff("settings", "done"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    if(buttonName=="medium"){
      buttonOn("settings", "medium");
      buttonOff("settings", "higher");
      genericSet("quality", "medium");
      /////createStream();
      if(uiPlaying){
        startRetrying();
        }
      }
    if(buttonName=="higher"){
      buttonOff("settings", "medium");
      buttonOn("settings", "higher");
      genericSet("quality", "higher");
      //////createStream();
      if(uiPlaying){
        startRetrying();
        }
      }

    }
  if(pageName=="faqs"){
    if(buttonName=="done"){
      buttonOn("faqs", "done");
      window.setTimeout('buttonOff("faqs", "done"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    }
  if(pageName=="events"){
    if(buttonName=="done"){
      buttonOn("events", "done");
      window.setTimeout('buttonOff("events", "done"); buttonOn("footnav", "listen"); selectPage("listen");', navDelay);
      }
    }
  if(pageName=="request"){
    if(buttonName=="done"){
      buttonOn("request", "done");
      window.setTimeout('buttonOff("request", "done"); buttonOn("footnav", "listen");  buttonOff("footnav", "request"); selectPage("listen");', navDelay);
      }
    if(buttonName=="faqs"){
      buttonOn("request", "faqs");
      buttonOff("footnav", "request");
      window.setTimeout('buttonOff("request", "faqs"); selectPage("faqs");', navDelay);
      }
    if(buttonName=="phone"){
      buttonOn("request", "phone");
      window.setTimeout('buttonOff("request", "phone")', navDelay*2);
      //window.location='tel:+16126264770';
      window.setTimeout("remoteLink('tel:+16126264770')", navDelay);
      }
    if(buttonName=="email"){
      buttonOn("request", "email");
      window.setTimeout('buttonOff("request", "email")', navDelay*2);
      //window.location='mailto:request@radiok.org?subject=Request from Radio K app';
      window.setTimeout("remoteLink('mailto:radiokdj@umn.edu?subject=Request from Radio K app')", navDelay);
      }
    if(buttonName=="tweet"){
      buttonOn("request", "tweet");
      window.setTimeout('buttonOff("request", "tweet")', navDelay*2);
      //window.location='https://twitter.com/intent/tweet?source=webclient&text=%40RadioK+%23Request';
      window.setTimeout("remoteLink('https://twitter.com/intent/tweet?source=webclient&text=%40RadioK+%23Request')", navDelay);
      }
    }
  if(pageName=="playlist"){
    if(buttonName=="refresh"){
      buttonOn("playlist", "refresh");
      window.setTimeout('buttonOff("playlist", "refresh")', navDelay*2);
      getRecentSongs();
      }
    }
  }
var minuteMs=60000;
function minuteTick(){
  dbuga('minuteTick()');
  if((uiPlaying==true)&&(streamPlaying==true)){
    updateNowPlaying();
    }
  getRecentSong();
  //dbuga('end of minuteTick()');
  }

function resumeGame(){
  //dbuga('resumeGame()');
  return true;
  }

var remoteControlPaused=false;
function remoteControlPause(){
  dbuga('remoteControlPause()');
  remoteControlPaused=true;
  uiPlaying=false;
  retrying=false;
  buttonOff("listen", "playpause");
  }
function remoteControlPlay(){
  dbuga('remoteControlPlay()');
  remoteControlPaused=false;
  uiPlaying=true;
  retrying=false;
  buttonOn("listen", "playpause");
  }


var lastTouchId="";
function handleTouchEvent(e){
  if(e.type=="touchstart"){
    if(e.touches.length==3){dbug('');}
    px=e.touches[0].pageX-leftOffset;
    py=e.touches[0].pageY-topOffset; 
    //dbuga('px:'+px+' py:'+py);
    var target=e.touches[0].target;
    var targetId=target.id; 
    lastTouchId=targetId;
    //dbuga(' target='+target+' target.id='+targetId);

    if((currentPage=="faqs")&&(targetId.indexOf('twistie')>-1)){// skip to twisties if faqs and target match
      if(selectedTwistie==-1){
        var parts=targetId.split('_');
        var targetNum=Number(parts[1]);
        selectTwistie(targetNum);
        }
      else{
        selectTwistie(-1);
        }
      }
    else{
      for (m=0; m<buttonMap.length; m++){
        area=buttonMap[m];
        if((px>area.left)&&(px<area.right)&&(py>area.top)&&(py<area.bottom)){
          if((currentPage==area.page)||(py>heightsByPage[currentPage])){// on page or footnav
            //dbuga('page:'+area.page+' name:'+area.name);
            if(area.name.indexOf('timeset')>-1){
              var mid=(area.top+area.bottom)/2;
              var tenth=Math.floor(10*(px-area.left)/(area.right-area.left));
              var pol=-1;
              if(mid>py){pol=1}
              if(tenth<4){alarmIncDec=pol*60;}
              if((tenth==4)||(tenth==5)){alarmIncDec=pol;}
              if(tenth>5){alarmIncDec=12*pol*60;}
              }
            //dbuga(area.page+" "+area.name);
            handleButton(area.page, area.name);
            }
          }
        }
      }
    }
  }
var alarmIncDec=1;
//document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);

</script>
</head>
<body onload="init()" onmousedown="moused(event);" ontouchstart="touchStart(event);" ontouchmove="touchMove(event);" ontouchend="touchEnd(event);" ontouchcancel="touchCancel(event);">

<div id="wrapper">
  <div id="container">
  </div>
  <div id="readyStateDiv" style="position:absolute; color:#fff; line-height:10px; "></div>
  <div id="debugDiv" style="top:20px; position:absolute;"></div>
  <div id="stateDiv" style="top:460px;"></div>
</div>
</body>
</html>